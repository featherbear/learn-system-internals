<!doctype html><html lang=en><head><meta charset=utf-8><title>Execution</title><meta name=apple-mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-status-bar-style content=black-translucent><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><link rel=stylesheet href=../../../reveal-js/css/reset.css><link rel=stylesheet href=../../../reveal-js/css/reveal.css><link rel=stylesheet href=../../../reveal-js/css/theme/black.css id=theme><link rel=stylesheet href=../../../highlight-js/default.min.css></head><body><div class=reveal><div class=slides><section data-noprocess data-shortcode-slide class=center><h1 id=execution>Execution</h1></section><section><h2 id=cpu-speed>CPU Speed</h2><p>The speed of a CPU is determined by its clock speed.</p><p>This speed refers to the rate (in Hz) at which the processor is able to generate pulses - that are used to synchronise its operations.</p><p>i.e. an Arduino (i.e. ATmega 328) operates at 16 MHz.<br>i.e. A Ryzen 9 3900X CPU operates at 3.8 GHz.</p></section><section><h2 id=execution-1>Execution</h2><p>In the CPU, there exists a Pointer Register known as the &ldquo;<code>program counter</code>&rdquo; (<code>PC</code>), which keeps track of the next instruction the processor should execute.</p><p>To execute instructions the CPU performs what is known as the &ldquo;<em>Fetch-Execute Cycle</em>&ldquo;</p></section><section><h2 id=fetch-decode-execute-cycle>Fetch-Decode-Execute Cycle</h2><ul><li>Fetch the instruction from the address in the program counter</li><li>Increment the program counter</li><li>Decode the instruction</li><li>Execute the instruction</li></ul><blockquote><p>Note: The program counter contains the <strong>address</strong> of the instruction</p><p>Note: An instruction can be multibyte</p></blockquote></section><section><h2 id=code-and-instructions>Code and Instructions</h2><section data-shortcode-section><p>Consider the below source code</p><blockquote><pre><code class=language-c>for (i = 0; i &lt; 20; i++) {
  ...
}
</code></pre></blockquote><p>This block of code requires around 4 instructions</p><ul><li>set <code>i</code> to <code>0</code></li><li>compare if <code>i</code> is less than <code>20</code></li><li>run the contents if true</li><li>increment <code>i</code></li></ul></section><section><p>The following code also requires several instructions</p><blockquote><pre><code class=language-c>if (a*2 == b + (c * 3)) {
  ...
}
</code></pre></blockquote><p>In fact it requires around 10 instructions!</p></section><section><blockquote><p>1 statement != 1 instruction</p></blockquote><p>&nbsp;<br>Some instructions require multiple CPU clock cycles</p><blockquote><p>1 GHz clock speed !== 1 billion IPS<br><em>(IPS - Instructions per Second)</em></p></blockquote></section></section><section><h2 id=branching>Branching</h2><section data-shortcode-section><p>In machine/assembly code, there is no such keyword atom for an &lsquo;if statement&rsquo;.</p><p>Instead, this is achieved by performing an instruction, followed by another instruction that uses the results of the first instruction.</p></section><section><p>i.e. Possible Intel x86 assembly code for<br><code>if (x == 3) { ... }</code></p><pre><code class=language-asm>mov eax, [ebp-0x8]
mov ebx, 3
cmp eax, ebx   &lt;--- This instruction compares x with 3
je 0x11223344  &lt;--- The results of the compare is used
</code></pre><p>When the <code>cmp</code> instruction is executed, a flag in the <a href=../overview/#/5>status register</a> of the CPU is set to reflect <code>x - 3 == 0</code>.<br>When the <code>je</code> instruction is executed, this flag is checked to see if it is true.</p></section><section><blockquote><p><code>je 0x11223344</code></p></blockquote><p>This is the &ldquo;jump if equal&rdquo; Intel x86 instruction.</p><p>When executed, the CPU will look inside its Status Register, and check if the Zero Flag (<code>ZF</code>) is set.</p><p>If set, the CPU will set its program counter (<code>PC</code>) to <code>0x11223344</code>. During the next <em>Fetch-Execute Cycle</em>, the instructions at <code>0x11223344</code> will be executed.</p><p>This process is known as <strong><em>branching</em></strong>.</p></section><section><h3 id=branch-delay-slots>Branch Delay Slots</h3><p>When a branching instruction has been executed, the CPU does not immediately execute the new instruction (as a result of the Fetch-Execute cycle).</p><p>Instead of &lsquo;doing nothing&rsquo; for those CPU cycles, an additional instruction can be executed before the CPU begins to execute the new address instructions.</p><p>This additional instruction is known as a &ldquo;branch delay slot instruction&rdquo;.</p></section><section><p>In cases where no additional instruction is wanted, a <code>nop</code> (no-operation) instruction can be placed in the branch delay slot.</p><pre><code class=language-mips>li  $a0, 42
jal fun     &lt;--- Instruction to jump to the label at `fun`
nop         &lt;--- Branch delay slot - do nothing
sw  $v0, x  &lt;!-- Will not execute as program has branched
</code></pre></section></section><section><h2 id=functions>Functions</h2><section data-shortcode-section><p>When a function is called, the processor will allocate some memory on the stack for the new function&rsquo;s stack frame. Inside the stack frame, it will store data crucial to the continuation of the system.</p><p>These include the current stack and base pointer addresses, and the address of the next instruction (which will be executed when the function returns)</p></section><section><p>Compared to the RAM in a computer system, there are a very limited number and capacity of registers in the CPU. When a function is called, it will most likely require the modification of these registers.</p><p>However if a function <code>A</code> relies on the execution of function <code>B</code>, but both functions require the use of registers - we will run into issues!</p><p>As consequence, we need to deal with these so called <em>conflict registers</em></p></section><section><h3 id=conflict-registers>Conflict Registers</h3><p>A conflict register is a term given to a register which is modified in a function.</p><p>As the register will be modified, it is a good idea to store the original value of the register, so that it can be restored after the function finishes.</p><p>These operations are performed in the function epilogue and function prologue.</p></section><section><h3 id=prologue>Prologue</h3><blockquote><p>aka &ldquo;setting up the stack frame&rdquo;</p></blockquote><p>The function prologue is a set of assembly instructions that are executed before the actual instructions of the function is called.</p><p>In the prologue, the conflict registers are stored on the stack - often with the <code>push</code> instruction</p></section><section><h3 id=epilogue>Epilogue</h3><blockquote><p>aka &ldquo;tearing down the stack frame&rdquo;</p></blockquote><p>The function epilogue is a set of assembly instructions executed after the function instructions are called.</p><p>In the epilogue, the original registered are restored from the stack - often with the <code>pop</code> instruction. These registers should be <code>pop</code>&rsquo;d in the reverse order that they were <code>push</code>&rsquo;d</p></section><section><h3 id=example-prologue-and-epilogue>Example Prologue and Epilogue</h3><pre><code>push r1       ; Function prologue
push r2       ;   Store the conflict registers r1, r2, r3
push r3

mov r1, 0xEF  ; your assembly instructions here
addi r2, 13
clr r3
xor r1, r3

pop r3        ; Function epilogue
pop r2        ;   Restore the conflict registers r3, r2, r1
pop r1
leave
ret
</code></pre></section></section></div></div><script type=text/javascript src=../../../reveal-hugo/object-assign.js></script><a href=../../../reveal-js/css/print/ id=print-location style=display:none></a><script type=text/javascript>var printLocationElement=document.getElementById('print-location');var link=document.createElement('link');link.rel='stylesheet';link.type='text/css';link.href=printLocationElement.href+(window.location.search.match(/print-pdf/gi)?'pdf.css':'paper.css');document.getElementsByTagName('head')[0].appendChild(link);</script><script type=application/json id=reveal-hugo-site-params>{"center":false,"history":true,"pdf_separate_fragments":false,"slide_number":true}</script><script type=application/json id=reveal-hugo-page-params>null</script><script src=../../../reveal-js/js/reveal.js></script><script type=text/javascript>function camelize(map){if(map){Object.keys(map).forEach(function(k){newK=k.replace(/(\_\w)/g,function(m){return m[1].toUpperCase()});if(newK!=k){map[newK]=map[k];delete map[k];}});}
return map;}
var revealHugoDefaults={center:true,controls:true,history:true,progress:true,transition:"slide"};var revealHugoSiteParams=JSON.parse(document.getElementById('reveal-hugo-site-params').innerHTML);var revealHugoPageParams=JSON.parse(document.getElementById('reveal-hugo-page-params').innerHTML);var options=Object.assign({},camelize(revealHugoDefaults),camelize(revealHugoSiteParams),camelize(revealHugoPageParams));Reveal.initialize(options);</script><script type=text/javascript src=../../../reveal-js/plugin/markdown/marked.js></script><script type=text/javascript src=../../../reveal-js/plugin/markdown/markdown.js></script><script type=text/javascript src=../../../reveal-js/plugin/highlight/highlight.js></script><script type=text/javascript src=../../../reveal-js/plugin/zoom-js/zoom.js></script><script type=text/javascript src=../../../reveal-js/plugin/notes/notes.js></script><script type=text/javascript>document.title+=" | Learn System Internals";window.MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},svg:{fontCache:'global'}};</script><script type=text/javascript id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js></script><script>if(window.location.search.match(/\?print-pdf/gi)){function insertCSS(src){const link=document.createElement('link');link.rel='stylesheet';link.type='text/css';link.href=src;document.getElementsByTagName('head')[0].appendChild(link);}
insertCSS('\/..\/reveal-js\/css\/print\/pdf.css');insertCSS('\/..\/hideHomeButton.css');}</script><a id=homeButton style=position:fixed;bottom:8px;left:8px;z-index:31;font-family:Helvetica,sans-serif;font-size:12px;line-height:1;color:#fff;background-color:rgba(0,0,0,.4);padding:5px;text-decoration:none href=../../../>Home</a></body></html>